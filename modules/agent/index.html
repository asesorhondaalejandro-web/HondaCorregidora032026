<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Honda CRM | Premium Access</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;700;900&display=swap" rel="stylesheet">
    <style>
        body { font-family: 'Inter', sans-serif; background-color: #0f172a; }
        
        /* Estilos de Tarjetas por Estatus */
        .st-new { border-top: 4px solid #facc15; }
        .st-contacted { border-top: 4px solid #22c55e; }
        .st-lost { border-top: 4px solid #ef4444; }
        .st-sold { border-top: 4px solid #3b82f6; }

        /* Glassmorphism Effect */
        .glass-card {
            background: rgba(255, 255, 255, 0.03);
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255, 255, 255, 0.1);
        }

        /* Custom Select */
        .custom-select {
            appearance: none;
            background-image: url("data:image/svg+xml;charset=UTF-8,%3csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 24 24' fill='none' stroke='white' stroke-width='2' stroke-linecap='round' stroke-linejoin='round'%3e%3cpolyline points='6 9 12 15 18 9'%3e%3c/polyline%3e%3c/svg%3e");
            background-repeat: no-repeat;
            background-position: right 0.75rem center;
            background-size: 1em;
        }

        .honda-gradient {
            background: linear-gradient(135deg, #cc0000 0%, #990000 100%);
        }

        input::placeholder { color: #94a3b8; }
    </style>
</head>
<body class="text-slate-200 pb-10">

    <nav class="bg-black/80 border-b border-white/10 p-4 sticky top-0 z-50 backdrop-blur-md">
        <div class="container mx-auto flex justify-between items-center">
            <div class="flex items-center gap-2">
                <div class="w-8 h-8 bg-white flex items-center justify-center rounded-sm">
                    <span class="text-red-600 font-black text-xl">H</span>
                </div>
                <h1 class="font-black text-2xl tracking-tighter italic text-white">LEAD<span class="text-red-600">PRO</span></h1>
            </div>
            <div id="status-tag" class="text-[9px] bg-slate-800 text-slate-400 px-3 py-1 rounded-full uppercase font-bold border border-white/10 tracking-widest">
                Syncing...
            </div>
        </div>
    </nav>

    <div class="container mx-auto p-4 max-w-xl">
        
        <div class="glass-card p-6 rounded-3xl mb-8 shadow-2xl">
            <div class="flex items-center gap-2 mb-4">
                <div class="h-4 w-1 honda-gradient"></div>
                <h3 class="text-xs font-black text-white uppercase tracking-[0.2em]">Nuevo Prospecto</h3>
            </div>
            <div class="grid grid-cols-1 gap-4">
                <div class="relative">
                    <input type="text" id="newName" placeholder="Nombre completo" 
                        class="w-full p-4 bg-white/5 border border-white/10 rounded-2xl text-sm outline-none focus:border-red-600 transition text-white">
                </div>
                <div class="relative">
                    <input type="tel" id="newPhone" placeholder="WhatsApp (10 dígitos)" 
                        class="w-full p-4 bg-white/5 border border-white/10 rounded-2xl text-sm outline-none focus:border-red-600 transition text-white">
                </div>
                <button onclick="saveLead()" 
                    class="honda-gradient w-full text-white font-black py-4 rounded-2xl hover:scale-[1.02] transition-all shadow-xl shadow-red-900/20 uppercase tracking-widest text-xs">
                    Registrar en Sistema
                </button>
            </div>
        </div>

        <div class="flex flex-col gap-3 mb-8">
            <div class="relative group">
                <div class="absolute inset-y-0 left-0 pl-4 flex items-center pointer-events-none">
                    <svg class="w-4 h-4 text-slate-500" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z"/></svg>
                </div>
                <input type="text" id="searchInput" placeholder="Buscar por nombre o celular..." 
                    class="w-full pl-11 p-4 bg-slate-900/50 rounded-2xl border border-white/5 focus:ring-2 focus:ring-red-600 outline-none text-sm transition">
            </div>
            <select id="advisorFilter" class="custom-select w-full p-4 bg-slate-900/50 border border-white/5 rounded-2xl text-xs font-bold text-slate-300">
                <option value="">Todos los Asesores</option>
            </select>
        </div>

        <div id="leadsList" class="space-y-4">
            <div class="animate-pulse flex space-x-4 glass-card p-6 rounded-3xl">
                <div class="flex-1 space-y-4 py-1">
                    <div class="h-4 bg-white/10 rounded w-3/4"></div>
                    <div class="space-y-2">
                        <div class="h-4 bg-white/10 rounded"></div>
                        <div class="h-4 bg-white/10 rounded w-5/6"></div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
        import { getFirestore, collection, addDoc, updateDoc, doc, query, orderBy, Timestamp, onSnapshot } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

        // Mantenemos tus llaves originales
        const firebaseConfig = {
            apiKey: "AIzaSyBbfZXYcBhg8xrBQ4i7LhKqmk7CZUz715Y",
            authDomain: "honda-crm-ventas.firebaseapp.com",
            projectId: "honda-crm-ventas",
            storageBucket: "honda-crm-ventas.firebasestorage.app",
            messagingSenderId: "186941272958",
            appId: "1:186941272958:web:9c5b73554a2d897c19b92f"
        };

        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);
        const leadsRef = collection(db, "artifacts/honda-crm-v1/public/data/leads");

        let allLeads = [];

        function cleanPhone(phoneStr) {
            if(!phoneStr) return '';
            const digits = phoneStr.replace(/\D/g, '');
            return digits.length > 10 ? digits.slice(-10) : digits;
        }

        function loadLeads() {
            const q = query(leadsRef, orderBy("createdAt", "desc"));
            onSnapshot(q, (snap) => {
                allLeads = snap.docs.map(d => ({ id: d.id, ...d.data() }));
                populateAdvisors();
                render();
                const tag = document.getElementById('status-tag');
                tag.innerText = "SISTEMA ONLINE";
                tag.className = "text-[9px] bg-green-500/10 text-green-400 border border-green-500/20 px-3 py-1 rounded-full uppercase font-bold tracking-widest";
            });
        }

        function populateAdvisors() {
            const select = document.getElementById('advisorFilter');
            const currentVal = select.value;
            const advisors = [...new Set(allLeads.map(l => l.advisorName).filter(a => a))];
            select.innerHTML = '<option value="">Filtrar por Asesor: Todos</option>';
            advisors.forEach(a => {
                const opt = document.createElement('option');
                opt.value = a; opt.innerText = a;
                select.appendChild(opt);
            });
            select.value = currentVal;
        }

        function render() {
            const list = document.getElementById('leadsList');
            const search = document.getElementById('searchInput').value.toLowerCase();
            const advisor = document.getElementById('advisorFilter').value;

            list.innerHTML = '';

            const filtered = allLeads.filter(l => {
                const matchesSearch = l.name?.toLowerCase().includes(search) || l.phone?.includes(search);
                const matchesAdvisor = !advisor || l.advisorName === advisor;
                return matchesSearch && matchesAdvisor;
            });

            filtered.forEach(lead => {
                const phone10 = cleanPhone(lead.phone);
                const date = lead.createdAt instanceof Timestamp ? lead.createdAt.toDate().toLocaleDateString('es-MX', {day:'2-digit', month:'short'}) : (lead.entryDate || '-');
                
                const card = document.createElement('div');
                card.className = `glass-card p-5 rounded-3xl shadow-xl transition-all border-l-0 st-${lead.status || 'new'}`;
                card.innerHTML = `
                    <div class="flex justify-between items-start mb-4">
                        <div class="flex-1">
                            <div class="flex items-center gap-2 mb-1">
                                <span class="text-[10px] font-black text-slate-500 uppercase tracking-tighter">${date}</span>
                                <span class="h-1 w-1 bg-slate-700 rounded-full"></span>
                                <span class="text-[10px] font-black text-red-500 uppercase italic tracking-widest">${lead.modelInterest || 'SIN MODELO'}</span>
                            </div>
                            <h2 class="font-black text-white text-xl leading-tight uppercase tracking-tighter mb-1">${lead.name || 'Anónimo'}</h2>
                            <p class="text-xs font-bold text-slate-400 italic">Asesor: ${lead.advisorName || 'Por asignar'}</p>
                        </div>
                        <div class="flex flex-col items-end gap-2">
                             <select onchange="updateStatus('${lead.id}', this.value)" 
                                class="custom-select text-[10px] font-black p-2 px-3 rounded-xl border border-white/10 bg-black text-white outline-none">
                                <option value="new" ${lead.status === 'new' ? 'selected' : ''}>NUEVO</option>
                                <option value="contacted" ${lead.status === 'contacted' ? 'selected' : ''}>CONTACTADO</option>
                                <option value="lost" ${lead.status === 'lost' ? 'selected' : ''}>PERDIDO</option>
                                <option value="sold" ${lead.status === 'sold' ? 'selected' : ''}>VENDIDO</option>
                            </select>
                            <span class="text-[14px] font-black text-slate-200 tracking-tighter">${phone10}</span>
                        </div>
                    </div>

                    <div class="grid grid-cols-2 gap-3 mt-6">
                        <a href="https://wa.me/52${phone10}" target="_blank" 
                           class="bg-green-600 hover:bg-green-500 text-white text-center py-4 rounded-2xl font-black text-[10px] flex items-center justify-center gap-2 transition-transform active:scale-95 shadow-lg shadow-green-900/20">
                           <svg class="w-4 h-4" fill="currentColor" viewBox="0 0 24 24"><path d="M.057 24l1.687-6.163c-1.041-1.804-1.588-3.849-1.587-5.946.003-6.556 5.338-11.891 11.893-11.891 3.181.001 6.167 1.24 8.413 3.488 2.245 2.248 3.481 5.236 3.48 8.417-.003 6.557-5.338 11.892-11.893 11.892-1.997-.001-3.951-.5-5.688-1.448l-6.305 1.654zm6.597-3.807c1.676.995 3.276 1.591 5.392 1.592 5.448 0 9.886-4.434 9.889-9.885.002-5.462-4.415-9.89-9.881-9.892-5.452 0-9.887 4.434-9.889 9.884-.001 2.225.651 3.891 1.746 5.634l-.999 3.648 3.742-.981z"/></svg>
                           WHATSAPP
                        </a>
                        <a href="tel:${phone10}" 
                           class="bg-white hover:bg-slate-200 text-black text-center py-4 rounded-2xl font-black text-[10px] flex items-center justify-center gap-2 transition-transform active:scale-95 shadow-lg">
                           <svg class="w-4 h-4" fill="currentColor" viewBox="0 0 24 24"><path d="M20 22.621l-3.521-6.795c-.008.004-1.974.97-2.064 1.011-2.24 1.086-6.799-7.82-4.509-8.954.058-.028 2.023-1 2.023-1l-3.351-6.483s-2.022.999-2.034 1.005c-3.058 1.559 2.507 20.457 5.627 18.817.024-.013 2.028-.999 2.028-.999L17.754 24l3.521-6.795z"/></svg>
                           LLAMADA
                        </a>
                    </div>
                `;
                list.appendChild(card);
            });
        }

        window.updateStatus = async (id, newStatus) => {
            try {
                const leadDoc = doc(db, "artifacts/honda-crm-v1/public/data/leads", id);
                await updateDoc(leadDoc, { status: newStatus });
            } catch (e) { console.error(e); }
        }

        window.saveLead = async () => {
            const nameInput = document.getElementById('newName');
            const phoneInput = document.getElementById('newPhone');
            if(!nameInput.value || !phoneInput.value) return alert("Completa los datos");

            try {
                await addDoc(leadsRef, {
                    name: nameInput.value, 
                    phone: cleanPhone(phoneInput.value), 
                    status: 'new',
                    createdAt: Timestamp.now(),
                    entryDate: new Date().toLocaleDateString('es-MX'),
                    advisorName: "Registro Local",
                    modelInterest: "POR DEFINIR"
                });
                nameInput.value = '';
                phoneInput.value = '';
            } catch (e) { alert("Error: " + e.message); }
        }

        document.getElementById('searchInput').addEventListener('input', render);
        document.getElementById('advisorFilter').addEventListener('change', render);

        loadLeads();
    </script>
</body>
</html>